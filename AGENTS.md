This repo enforces Edit-Only changes. No new files. Follow this document strictly.

応答は日本語で回答しましょう。

# AGENTS: Python 汎用エージェント設計ガイド

どのプロジェクトにも持ち込める最小構成ポリシーをまとめたガイドです。余計な生成を防ぎ、既存リポジトリの流儀を崩さずにエージェント機能を追加するための基準を示します。

## ガイド概要
- 依存は `uv`（`uv add`）で管理し、仮想環境は `.venv`
- 配布は `pip` を前提にし、手順は `README.md` に記載
- 構造はレイヤーの設計思想を意識しつつ、命名や配置を強制しない
- 抽象 (`ABC` / `Protocol`) を優先し、単一責務 + 公開 API 最小化を維持
- `.env.example` に許可キーのみ記載し、環境変数は安易に増やさない
- ドキュメントは英日で二つのファイルを作る(例：　`README.md` / `README_ja.md`）、コードコメントは英語の後にスラッシュで日本語を併記 例：英語の説明/日本語の説明

## 1. Minimal Layout（固定部分のみ記載）
```text
.
├─ AGENTS.md
├─ README.md / README_ja.md
├─ pyproject.toml
├─ docs/
├─ tests/
├─ examples/
└─ src/<your_pkg>/

```
既存構成・命名規約を尊重し、以降の構成は各プロジェクトの規約に従う。具体的なファイル名を列挙して新規生成を誘導しない。

## 2. 開発セットアップ（`.venv` + `uv`）
```bash
uv venv --seed
# Windows: .venv\Scripts\activate
# POSIX: source .venv/bin/activate
uv add pydantic-settings
# 必要に応じて: uv add pytest pytest-timeout typer rich
uv pip install -e .
```

## 3. パッケージング方針（`pip` 前提）
- `README.md` / `README_ja.md` に Install / Quickstart / 主要スニペットを用意
- `.env.example` は許可されたキーのみ列挙し、追加は設計レビューで審査
- 公開 API は既存の公開窓口（例: `__init__.py`）で最小限のみ再エクスポート

## 4. 設計原則（プロジェクト横断規約）
- **単一責務**: 1 クラス = 1 責務。肥大化は合成で回避し、God クラスは禁止
- **抽象優先**: 外部依存（LLM / Memory / Tracer / Tool 等）は `ABC` / `Protocol` で宣言
- **具象の注入**: 具体 SDK/API はアダプタ化し、既存の DI / 組立ポイントで注入
- **入口の明確化**: 触れるエントリーポイントを既存のユースケース・抽象に限定し、Wrapper/Helper の乱立を防止
- **設定を増やさない**: `.env.example` のキーは固定・厳選。追加は設計レビューを必須化
- **Fail-Fast or Log & Recover** を対象に応じて明示
  - ライブラリ/フレームワーク: Fail-Fast（即時例外 + 原因表示）
  - システム/アプリ: ログ記録・再試行・代替経路などを設計に含める
- テストは実装と同時に作成し常にグリーンを維持（TDD 推奨）

## 5. 機能追加の運用ポリシー
- 原則として新規ファイルは作らず、既存ファイルへの追記・差し替えで対応
- 真に必要な場合のみ 1 ファイル以内で追加し、命名は既存規約に完全準拠
- 追加可能なのは明示された機能（例: 特定 SDK のアダプタ）のみで、抽象や DTO の先出し量産は禁止
- `.env` キーの追加は禁止。既存キーで表現できない場合は「設計レビュー保留」と記録
- 公開 API の増加は抑制し、必要な場合は既存公開窓口に限定的に追加

## 6. 実行 & テスト戦略（120 秒対策 / 現物優先）
- **小分け実行**: テストはファイル・マーカー・パターンで狙い撃ち
  - 例: `uv run pytest -q -k "unit and agent" --timeout=15`
- **現物優先 / スタブ最小**: 外部 I/O は最小権限・最小データで実 API を基本とし、フェイクは最後の手段
- **分割基準**: テストファイル単位で 10〜30 秒以内に完結する粒度に分割
- **タイムアウト標準化**: `pytest-timeout` を導入し、デフォルト 15 秒を `conftest.py` 等で適用
- **Skip-Fast 運用**: 外部要因で不安定なケースは `pytest.skip` で即座にスキップし、理由を明記
- 既存の環境切替（例: `AGENTS_PROFILE`）を活用し、新規プロファイルは増やさない
- **ハング検知手順**: テストや Flow 実行が停止した場合は、対象シナリオを関数単位に分割し、各区間に `print` などのデバッグメッセージを追加して停止地点を特定する。デバッグログは原因特定後に最小限へ整理する。

## 7. 生成系（Codex など）へのガード文
- プロンプト末尾に以下を必ず追記して、余計な生成を抑止
  - 既存ファイルのみ編集。ユーザーの指示のない新規作成は禁止（必要な場合は １つのソースコード、１組の日英の文書ファイルまで、名称は既存規約に従うこと）
  - 具体的なファイル名・パスは提示しない
  - `.env.example` のキー追加は禁止。不可なら「設計レビュー保留」と記載
  - テストは既存の最小テストへ追記のみで、新規テストファイルは禁止
  - 出力は差分（関数単位の追記/置換 or パッチ形式）のみに限定し、テンプレートの丸ごと出力は禁止
